/* =========================================================
   QSC 점검 템플릿 더미데이터 (PostgreSQL)
   - 4개 테이블: qsc_template, qsc_template_categories,
                qsc_template_items, qsc_template_scope
   - 템플릿 5개: 요청하신 레코드 기준
   - 각 템플릿마다 카테고리 4개(CLEANLINESS/SERVICE/QUALITY/SAFETY)
   - 각 카테고리마다 문항 3개씩(템플릿당 12문항)
   ========================================================= */

BEGIN;

-- ---------- 0) 기존 객체 정리(재실행 용) ----------
DROP TABLE IF EXISTS qsc_template_items CASCADE;
DROP TABLE IF EXISTS qsc_template_categories CASCADE;
DROP TABLE IF EXISTS qsc_template_scope CASCADE;
DROP TABLE IF EXISTS qsc_template CASCADE;

DROP TYPE IF EXISTS qsc_inspection_type;
DROP TYPE IF EXISTS qsc_template_status;
DROP TYPE IF EXISTS qsc_category_code;
DROP TYPE IF EXISTS qsc_scope_type;

-- ---------- 1) ENUM 타입 ----------
CREATE TYPE qsc_inspection_type AS ENUM ('REGULAR', 'SPECIAL', 'REINSPECTION');
CREATE TYPE qsc_template_status AS ENUM ('ACTIVE', 'INACTIVE');
CREATE TYPE qsc_category_code   AS ENUM ('CLEANLINESS', 'SERVICE', 'QUALITY', 'SAFETY');
CREATE TYPE qsc_scope_type      AS ENUM ('GLOBAL', 'REGION', 'STORE', 'DIRECT');

-- ---------- 2) 테이블 생성 ----------
CREATE TABLE qsc_template (
  template_id        BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_by_user_id BIGINT NOT NULL,
  template_name      TEXT   NOT NULL,
  inspection_type    qsc_inspection_type NOT NULL,
  version            TEXT   NOT NULL,
  effective_from     DATE   NOT NULL,
  effective_to       DATE   NULL,
  pass_score_min     INT    NOT NULL,
  status             qsc_template_status NOT NULL DEFAULT 'ACTIVE',
  created_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at         TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE qsc_template_categories (
  template_category_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  template_id          BIGINT NOT NULL REFERENCES qsc_template(template_id) ON DELETE CASCADE,
  category_code        qsc_category_code NOT NULL,
  category_name        TEXT NOT NULL,
  category_weight      INT  NOT NULL,
  created_at           TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at           TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (template_id, category_code)
);

CREATE TABLE qsc_template_items (
  template_item_id     BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  template_id          BIGINT NOT NULL REFERENCES qsc_template(template_id) ON DELETE CASCADE,
  template_category_id BIGINT NOT NULL REFERENCES qsc_template_categories(template_category_id) ON DELETE CASCADE,
  item_name            TEXT NOT NULL,
  is_required          BOOLEAN NOT NULL DEFAULT TRUE,
  sort_order           INT NOT NULL,
  created_at           TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at           TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE qsc_template_scope (
  template_scope_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  template_id       BIGINT NOT NULL REFERENCES qsc_template(template_id) ON DELETE CASCADE,
  scope_type        qsc_scope_type NOT NULL,
  scope_ref_id      BIGINT NULL,
  created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  -- scope_type별 ref 규칙 (이미지 설명 반영)
  CONSTRAINT chk_scope_ref
    CHECK (
      (scope_type = 'GLOBAL' AND scope_ref_id IS NULL)
      OR (scope_type IN ('REGION','STORE') AND scope_ref_id IS NOT NULL)
      OR (scope_type = 'DIRECT') -- DIRECT는 상황에 따라 NULL/NOT NULL 허용
    )
);

-- (선택) 인덱스
CREATE INDEX idx_qsc_template_categories_template_id ON qsc_template_categories(template_id);
CREATE INDEX idx_qsc_template_items_template_id      ON qsc_template_items(template_id);
CREATE INDEX idx_qsc_template_items_category_id      ON qsc_template_items(template_category_id);
CREATE INDEX idx_qsc_template_scope_template_id      ON qsc_template_scope(template_id);

-- ---------- 3) 템플릿 5개 (요청하신 값 그대로) ----------
INSERT INTO qsc_template
  (template_id, created_by_user_id, template_name, inspection_type, version, effective_from, effective_to, pass_score_min, status)
VALUES
  (1, 1, '정기 점검 v1 (기본)',      'REGULAR',      'v1.0', DATE '2025-03-01', NULL,              70, 'ACTIVE'),
  (2, 1, '정기 점검 v2 (기준 강화)', 'REGULAR',      'v2.0', DATE '2025-5-01', NULL,              70, 'ACTIVE'),
  (3, 1, '정기 점검 v3 (개선 반영)', 'REGULAR',      'v3.0', DATE '2025-07-01', NULL,              70, 'ACTIVE'),
  (4, 2, '특별 점검 (봄-여름)',      'SPECIAL',      'sp.1', DATE '2025-03-01', DATE '2025-08-31', 70, 'ACTIVE'),
  (5, 2, '재점검 (불합격 후)',       'REINSPECTION', 're.1', DATE '2025-03-01', NULL,              70, 'ACTIVE');

-- ---------- 4) 템플릿 스코프(예시 더미) ----------
-- 필요에 맞게 scope_ref_id(지역/매장 ID)를 바꾸면 됩니다.
INSERT INTO qsc_template_scope (template_scope_id, template_id, scope_type, scope_ref_id) VALUES
  (10001, 1, 'GLOBAL', NULL),
  (10002, 2, 'GLOBAL', NULL),
  (10003, 3, 'GLOBAL', NULL),
  (10004, 4, 'REGION', 10),    -- 예: region_id=10
  (10005, 5, 'STORE',  2001);  -- 예: store_id=2001

-- ---------- 5) 카테고리 4종 x 템플릿 5개 ----------
-- weight: CLEANLINESS=30, SERVICE=30, QUALITY=30, SAFETY=10
INSERT INTO qsc_template_categories
  (template_category_id, template_id, category_code, category_name, category_weight)
VALUES
  -- template 1
  (11001, 1, 'CLEANLINESS', '청결', 30),
  (11002, 1, 'SERVICE',     '서비스', 30),
  (11003, 1, 'QUALITY',     '품질', 30),
  (11004, 1, 'SAFETY',      '안전', 10),

  -- template 2
  (12001, 2, 'CLEANLINESS', '청결', 30),
  (12002, 2, 'SERVICE',     '서비스', 30),
  (12003, 2, 'QUALITY',     '품질', 30),
  (12004, 2, 'SAFETY',      '안전', 10),

  -- template 3
  (13001, 3, 'CLEANLINESS', '청결', 30),
  (13002, 3, 'SERVICE',     '서비스', 30),
  (13003, 3, 'QUALITY',     '품질', 30),
  (13004, 3, 'SAFETY',      '안전', 10),

  -- template 4
  (14001, 4, 'CLEANLINESS', '청결(계절 특별)', 30),
  (14002, 4, 'SERVICE',     '서비스(계절 특별)', 30),
  (14003, 4, 'QUALITY',     '품질(계절 특별)', 30),
  (14004, 4, 'SAFETY',      '안전(계절 특별)', 10),

  -- template 5
  (15001, 5, 'CLEANLINESS', '청결(재점검)', 30),
  (15002, 5, 'SERVICE',     '서비스(재점검)', 30),
  (15003, 5, 'QUALITY',     '품질(재점검)', 30),
  (15004, 5, 'SAFETY',      '안전(재점검)', 10);

-- ---------- 6) 문항(아이템) 생성: 템플릿당 12개(카테고리별 3개) ----------
-- template 1
INSERT INTO qsc_template_items
  (template_item_id, template_id, template_category_id, item_name, is_required, sort_order)
VALUES
  (21001, 1, 11001, '홀/주방 바닥 청결 상태 양호', TRUE, 1),
  (21002, 1, 11001, '조리도구 세척/살균 상태 적정', TRUE, 2),
  (21003, 1, 11001, '쓰레기 분리수거/보관 상태 적정', TRUE, 3),

  (21004, 1, 11002, '직원 인사 및 응대 태도 적정', TRUE, 1),
  (21005, 1, 11002, '대기/응대 안내 문구 및 동선 명확', FALSE, 2),
  (21006, 1, 11002, '클레임 대응 프로세스 준수', TRUE, 3),

  (21007, 1, 11003, '원재료 유통기한/라벨 관리 적정', TRUE, 1),
  (21008, 1, 11003, '제품 제공 품온/품질 기준 준수', TRUE, 2),
  (21009, 1, 11003, '표준 레시피/정량 준수', TRUE, 3),

  (21010, 1, 11004, '소화기/비상구 표지 상태 양호', TRUE, 1),
  (21011, 1, 11004, '전기/가스 안전 점검 체크 완료', TRUE, 2),
  (21012, 1, 11004, '미끄럼/낙상 위험 요소 제거', FALSE, 3);

-- template 2 (기준 강화: 문항 텍스트 약간 강화)
INSERT INTO qsc_template_items
  (template_item_id, template_id, template_category_id, item_name, is_required, sort_order)
VALUES
  (22001, 2, 12001, '홀/주방 바닥 오염(물기/기름) 즉시 제거', TRUE, 1),
  (22002, 2, 12001, '조리도구 살균 기록 및 보관 상태 적정', TRUE, 2),
  (22003, 2, 12001, '냉장/냉동 구역 청결 및 정리정돈 적정', TRUE, 3),

  (22004, 2, 12002, '응대 멘트/복장/위생(마스크/장갑) 기준 준수', TRUE, 1),
  (22005, 2, 12002, '피크타임 대기 안내 및 컴플레인 사전 고지', TRUE, 2),
  (22006, 2, 12002, 'CS 이슈 기록 및 공유 체계 운영', TRUE, 3),

  (22007, 2, 12003, '원재료 입고 검수(온도/라벨) 기록 보관', TRUE, 1),
  (22008, 2, 12003, '제품 제공 품온/외관 불량 0건 유지', TRUE, 2),
  (22009, 2, 12003, '레시피 편차(정량) 허용범위 내 유지', TRUE, 3),

  (22010, 2, 12004, '비상구/피난 통로 적치물 0건', TRUE, 1),
  (22011, 2, 12004, '가스 누출 점검 및 차단 밸브 접근 가능', TRUE, 2),
  (22012, 2, 12004, '안전 표지/주의문 부착 상태 양호', TRUE, 3);

-- template 3 (개선 반영: 개선/추적 문항 추가)
INSERT INTO qsc_template_items
  (template_item_id, template_id, template_category_id, item_name, is_required, sort_order)
VALUES
  (23001, 3, 13001, '청결 점검 결과 개선조치 완료(재발 방지 포함)', TRUE, 1),
  (23002, 3, 13001, '살균/세척 주기표 운영 및 이탈 0건', TRUE, 2),
  (23003, 3, 13001, '작업대/손잡이 접촉면 위생(교차오염) 관리', TRUE, 3),

  (23004, 3, 13002, '고객 응대 품질(응대시간/정확성) 목표 준수', TRUE, 1),
  (23005, 3, 13002, '불만 접수 시 1차 응답 SLA 준수', TRUE, 2),
  (23006, 3, 13002, '직원 교육 이수(서비스) 확인', FALSE, 3),

  (23007, 3, 13003, '핵심 메뉴 품질 체크(샘플링) 수행', TRUE, 1),
  (23008, 3, 13003, '품질 이슈 원인/개선 이력 기록', TRUE, 2),
  (23009, 3, 13003, '보관 온도 이탈 시 폐기/조치 준수', TRUE, 3),

  (23010, 3, 13004, '정기 안전점검 체크리스트 이행', TRUE, 1),
  (23011, 3, 13004, '사고/아차사고 보고 및 재발방지 조치', FALSE, 2),
  (23012, 3, 13004, '위험물/세제 보관 분리 및 라벨링', TRUE, 3);

-- template 4 (특별 점검: 계절 이슈)
INSERT INTO qsc_template_items
  (template_item_id, template_id, template_category_id, item_name, is_required, sort_order)
VALUES
  (24001, 4, 14001, '해충 유입 차단(방충망/트랩) 상태 양호', TRUE, 1),
  (24002, 4, 14001, '고온다습 구역 곰팡이/악취 관리', TRUE, 2),
  (24003, 4, 14001, '제빙기/정수기 위생 점검 완료', TRUE, 3),

  (24004, 4, 14002, '성수기 혼잡 시 응대/정리 동선 운영', TRUE, 1),
  (24005, 4, 14002, '계절 메뉴 안내/품절 안내 정확', TRUE, 2),
  (24006, 4, 14002, '냉음료/빙과 제공 시 위생장갑 사용', FALSE, 3),

  (24007, 4, 14003, '냉장/냉동 온도 기록(여름철 강화) 준수', TRUE, 1),
  (24008, 4, 14003, '해동/보관 기준 준수(시간/온도)', TRUE, 2),
  (24009, 4, 14003, '원재료 신선도(색/냄새) 이상 없음', TRUE, 3),

  (24010, 4, 14004, '폭우/태풍 대비 누수/감전 위험 점검', TRUE, 1),
  (24011, 4, 14004, '미끄럼 방지 매트/표지판 운영', TRUE, 2),
  (24012, 4, 14004, '냉방기기 전원/배선 상태 점검', FALSE, 3);

-- template 5 (재점검: 불합격 후 개선 확인)
INSERT INTO qsc_template_items
  (template_item_id, template_id, template_category_id, item_name, is_required, sort_order)
VALUES
  (25001, 5, 15001, '이전 미흡 항목(청결) 개선 완료 증빙', TRUE, 1),
  (25002, 5, 15001, '재발 방지 체크리스트 운영 확인', TRUE, 2),
  (25003, 5, 15001, '담당자 지정 및 청결 책임 구역 설정', TRUE, 3),

  (25004, 5, 15002, '이전 미흡 항목(서비스) 개선 완료', TRUE, 1),
  (25005, 5, 15002, 'CS 처리 이력 및 후속 조치 확인', TRUE, 2),
  (25006, 5, 15002, '직원 교육(서비스) 재이수 확인', FALSE, 3),

  (25007, 5, 15003, '이전 미흡 항목(품질) 개선 완료', TRUE, 1),
  (25008, 5, 15003, '레시피/정량 준수 재검증 통과', TRUE, 2),
  (25009, 5, 15003, '유통기한/보관온도 이탈 0건 확인', TRUE, 3),

  (25010, 5, 15004, '이전 미흡 항목(안전) 조치 완료', TRUE, 1),
  (25011, 5, 15004, '점검표/장비 상태(소화기 등) 적정', TRUE, 2),
  (25012, 5, 15004, '위험요인 제거 및 표지/교육 완료', TRUE, 3);

COMMIT;
